generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DEALER
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  SHIPPED
  DELIVERED
  CANCELLED
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String
  role            UserRole  @default(DEALER)
  companyName     String
  contactName     String
  phone           String?
  taxId           String?
  taxOffice       String?
  address         String?
  city            String?
  discountPercent    Decimal?  @db.Decimal(5, 2)
  allowedCollections Json?     @default("[]")
  allowedVendors     Json?     @default("[]")
  isActive           Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  orders                  Order[]
  dealerCategoryDiscounts DealerCategoryDiscount[]
  dealerProductDiscounts  DealerProductDiscount[]
  favorites               Favorite[]
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  dealer          User        @relation(fields: [dealerId], references: [id])
  dealerId        String
  status          OrderStatus @default(PENDING)
  subtotal        Decimal     @db.Decimal(10, 2)
  discountPercent Decimal     @db.Decimal(5, 2)
  totalAmount     Decimal     @db.Decimal(10, 2)
  currency        String      @default("TRY")
  notes           String?
  adminNotes      String?
  rejectionReason String?
  dueDate         DateTime?
  shippingMethod  String?
  trackingNumber  String?
  proformaUrl     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]
}

model OrderItem {
  id               String  @id @default(cuid())
  order            Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId          String
  shopifyProductId String
  shopifyVariantId String
  title            String
  variantTitle     String?
  sku              String?
  imageUrl         String?
  quantity         Int
  retailPrice      Decimal @db.Decimal(10, 2)
  wholesalePrice   Decimal @db.Decimal(10, 2)
  discountPercent  Decimal @db.Decimal(5, 2)
  lineTotal        Decimal @db.Decimal(10, 2)
}

model ProductCache {
  id               String   @id
  shopifyProductId String   @unique
  title            String
  handle           String
  vendor           String?
  productType      String?
  status           String
  variants         Json
  images           Json
  tags             String[]
  collections      Json?    @default("[]")
  syncedAt         DateTime @default(now())
  favorites        Favorite[]
}

model CategoryDiscount {
  id                   String  @id @default(cuid())
  shopifyCollectionId  String  @unique
  collectionTitle      String
  discountPercent      Decimal @db.Decimal(5, 2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model ProductDiscount {
  id               String  @id @default(cuid())
  shopifyProductId String  @unique
  productTitle     String
  discountPercent  Decimal @db.Decimal(5, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DiscountTier {
  id              String   @id @default(cuid())
  discountType    String   // "product" | "category" | "global"
  referenceId     String   // shopifyProductId, shopifyCollectionId, or "global"
  minQuantity     Int
  discountPercent Decimal  @db.Decimal(5, 2)
  createdAt       DateTime @default(now())

  @@unique([discountType, referenceId, minQuantity])
}

model DealerCategoryDiscount {
  id                  String   @id @default(cuid())
  dealerId            String
  dealer              User     @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  shopifyCollectionId String
  collectionTitle     String
  discountPercent     Decimal  @db.Decimal(5, 2)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([dealerId, shopifyCollectionId])
}

model DealerProductDiscount {
  id               String   @id @default(cuid())
  dealerId         String
  dealer           User     @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  shopifyProductId String
  productTitle     String
  discountPercent  Decimal  @db.Decimal(5, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([dealerId, shopifyProductId])
}

model Favorite {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productCacheId String
  product        ProductCache @relation(fields: [productCacheId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@unique([userId, productCacheId])
}

model Settings {
  id                String  @id @default("global")
  discountPercent   Decimal @db.Decimal(5, 2) @default(20)
  companyName       String  @default("Büyüklere Oyuncaklar")
  companyAddress    String?
  companyPhone      String?
  companyEmail      String?
  companyTaxId      String?
  companyTaxOffice  String?
  companyLogo       String?
  bankName          String?
  bankIban          String?
  bankAccountHolder String?
  bankSwift         String?
  paymentTerms      String?
  defaultDueDays    Int     @default(30)
  cargoInfo         String?
  updatedAt         DateTime @updatedAt
}
